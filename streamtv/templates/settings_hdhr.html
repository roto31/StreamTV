{% extends "base.html" %}
{% block title %}HDHomeRun Settings - StreamTV{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <div>
            <div class="page-title">HDHomeRun Settings</div>
            <p class="page-subtitle">Configure HDHomeRun emulation for Plex, Emby, and Jellyfin integration.</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-outlined" type="button" id="refreshHdhrSettingsButton">
                <span class="material-icons">refresh</span>
                Reload
            </button>
            <button class="btn btn-primary" type="button" id="saveHdhrSettingsButton">
                <span class="material-icons">save</span>
                Save Changes
            </button>
        </div>
    </div>
    
    <div class="card status-card" id="statusCard" style="display: none;">
        <span id="statusMessage"></span>
    </div>
    
    <div class="settings-grid">
        <div class="card settings-card">
            <div class="card-title">General</div>
            <div class="form-group">
                <label for="enabled">
                    <input type="checkbox" id="enabled" style="width: auto; margin-right: 8px;">
                    Enable HDHomeRun Emulation
                </label>
                <small>Enable HDHomeRun emulation to allow Plex, Emby, and Jellyfin to discover and use StreamTV as an HDHomeRun device.</small>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-title">Device Configuration</div>
            <div class="form-group">
                <label for="deviceId">Device ID</label>
                <input type="text" id="deviceId" placeholder="FFFFFFFF" pattern="[0-9A-Fa-f]{8}">
                <small>8-character hexadecimal device identifier. Default: FFFFFFFF</small>
            </div>
            <div class="form-group">
                <label for="friendlyName">Friendly Name</label>
                <input type="text" id="friendlyName" placeholder="StreamTV HDHomeRun">
                <small>Display name shown in media server clients.</small>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-title">Tuners</div>
            <div class="form-group">
                <label for="tunerCount">Tuner Count</label>
                <input type="number" id="tunerCount" min="1" max="16" value="2">
                <small>Number of virtual tuners available. Each tuner can stream one channel simultaneously. Range: 1-16</small>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-title">Discovery</div>
            <div class="form-group">
                <label for="enableSsdp">
                    <input type="checkbox" id="enableSsdp" style="width: auto; margin-right: 8px;">
                    Enable SSDP Discovery
                </label>
                <small>Enable SSDP (Simple Service Discovery Protocol) for automatic device discovery. Requires port 1900/UDP. If disabled, manually add device at /hdhomerun/discover.json</small>
            </div>
        </div>
    </div>
    
    <div class="card info-card" style="margin-top: 16px;">
        <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 20px;">info</span>
            Information
        </div>
        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 15px; line-height: 1.5;">
            <p><strong>HDHomeRun Emulation:</strong> StreamTV can emulate an HDHomeRun device, allowing media servers like Plex, Emby, and Jellyfin to discover and use your channels as if they were coming from a physical HDHomeRun tuner.</p>
            <p style="margin-top: 8px;"><strong>Tuner Count:</strong> Each tuner represents a simultaneous stream. Increase this value if you expect multiple clients to watch different channels at the same time. Note that each tuner consumes server resources.</p>
            <p style="margin-top: 8px;"><strong>SSDP Discovery:</strong> When enabled, StreamTV will broadcast its presence on your local network, allowing media servers to automatically discover it. If disabled, you'll need to manually add the device using the discover.json endpoint.</p>
            <p style="margin-top: 8px;"><strong>Note:</strong> Changes to HDHomeRun settings require a server restart to take effect.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .page {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.36px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        margin-top: 4px;
        font-size: 17px;
    }
    
    .page-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .status-card {
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 12px 16px;
        font-size: 15px;
    }
    
    .status-card.success {
        color: var(--success);
        border-color: rgba(52, 199, 89, 0.4);
        background: rgba(52, 199, 89, 0.15);
    }
    
    .status-card.error {
        color: var(--error);
        border-color: rgba(255, 59, 48, 0.4);
        background: rgba(255, 59, 48, 0.15);
    }
    
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }
    
    .settings-card {
        background: var(--surface);
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .info-card {
        background: var(--surface);
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 16px;
    }
    
    .card-title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .form-group label {
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .form-group input[type="checkbox"] {
        width: auto;
        min-height: auto;
        margin-right: 8px;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        background: var(--surface-light);
        border-radius: 10px;
        border: 0.5px solid var(--divider);
        color: var(--text-primary);
        font-size: 17px;
        padding: 10px 12px;
        font-family: inherit;
        min-height: 44px;
        resize: vertical;
    }
    
    .form-group textarea {
        min-height: 120px;
    }
    
    .form-group small {
        color: var(--text-secondary);
        font-size: 13px;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        const refreshButton = document.getElementById('refreshHdhrSettingsButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => loadSettings(true));
        }

        const saveButton = document.getElementById('saveHdhrSettingsButton');
        if (saveButton) {
            saveButton.addEventListener('click', saveSettings);
        }

        loadSettings();
    });
    
    async function loadSettings(showStatus = false) {
        try {
            const response = await fetch('/api/settings/hdhr');
            if (!response.ok) {
                throw new Error('Failed to load settings');
            }
            const data = await response.json();
            document.getElementById('enabled').checked = data.enabled || false;
            document.getElementById('deviceId').value = data.device_id || 'FFFFFFFF';
            document.getElementById('friendlyName').value = data.friendly_name || 'StreamTV HDHomeRun';
            document.getElementById('tunerCount').value = data.tuner_count || 2;
            document.getElementById('enableSsdp').checked = data.enable_ssdp !== false;
            if (showStatus) {
                showStatusMessage('Settings refreshed from disk.', 'success');
            }
        } catch (error) {
            console.error(error);
            showStatusMessage(error.message, 'error');
        }
    }
    
    async function saveSettings() {
        try {
            const payload = {
                enabled: document.getElementById('enabled').checked,
                device_id: document.getElementById('deviceId').value || null,
                friendly_name: document.getElementById('friendlyName').value || null,
                tuner_count: Number(document.getElementById('tunerCount').value) || 2,
                enable_ssdp: document.getElementById('enableSsdp').checked,
            };
            
            // Validate device ID format
            if (payload.device_id && !/^[0-9A-Fa-f]{8}$/.test(payload.device_id)) {
                throw new Error('Device ID must be exactly 8 hexadecimal characters');
            }
            
            // Validate tuner count
            if (payload.tuner_count < 1 || payload.tuner_count > 16) {
                throw new Error('Tuner count must be between 1 and 16');
            }
            
            const response = await fetch('/api/settings/hdhr', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorPayload = await response.json();
                throw new Error(errorPayload.detail || 'Failed to save settings');
            }
            
            showStatusMessage('HDHomeRun settings saved. Please restart the server for changes to take effect.', 'success');
        } catch (error) {
            console.error(error);
            showStatusMessage(error.message, 'error');
        }
    }
    
    function showStatusMessage(message, status) {
        const card = document.getElementById('statusCard');
        const text = document.getElementById('statusMessage');
        card.classList.remove('success', 'error');
        card.classList.add(status);
        text.textContent = message;
        card.style.display = 'block';
        setTimeout(() => {
            card.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}

