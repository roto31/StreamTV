{% extends "base.html" %}

{% block title %}Plex Server Logs - StreamTV{% endblock %}

{% block extra_styles %}
<style>
    .logs-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
    }
    
    .logs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 0.5px solid var(--divider);
    }
    
    .logs-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .logs-controls select,
    .logs-controls input {
        padding: 8px 12px;
        background: var(--surface);
        border: 0.5px solid var(--divider);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 15px;
        min-height: 36px;
    }
    
    .logs-viewer {
        flex: 1;
        background: var(--surface);
        border: 0.5px solid var(--divider);
        border-radius: 12px;
        padding: 16px;
        overflow-y: auto;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        font-size: 13px;
        line-height: 1.6;
    }
    
    .log-entry {
        padding: 4px 0;
        border-bottom: 0.5px solid transparent;
        transition: background 0.2s;
    }
    
    .log-entry:hover {
        background: var(--hover);
        border-bottom-color: var(--divider);
    }
    
    .log-entry.error {
        color: var(--error);
    }
    
    .log-entry.warning {
        color: var(--warning);
    }
    
    .log-entry.info {
        color: var(--text-secondary);
    }
    
    .log-entry.debug {
        color: var(--text-disabled);
    }
    
    .log-timestamp {
        color: var(--text-disabled);
        margin-right: 8px;
    }
    
    .log-level {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin-right: 8px;
        min-width: 60px;
        text-align: center;
    }
    
    .log-level.ERROR {
        background: rgba(255, 59, 48, 0.2);
        color: var(--error);
    }
    
    .log-level.WARNING {
        background: rgba(255, 149, 0, 0.2);
        color: var(--warning);
    }
    
    .log-level.INFO {
        background: rgba(10, 132, 255, 0.2);
        color: var(--info);
    }
    
    .log-level.DEBUG {
        background: rgba(142, 142, 147, 0.2);
        color: var(--text-disabled);
    }
    
    .log-message {
        flex: 1;
    }
    
    .auto-scroll-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--surface);
        border: 0.5px solid var(--divider);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 13px;
        color: var(--text-secondary);
        display: none;
        cursor: pointer;
    }
    
    .auto-scroll-indicator.active {
        display: block;
    }
    
    .log-file-selector {
        padding: 8px 12px;
        background: var(--surface);
        border: 0.5px solid var(--divider);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 15px;
        min-height: 36px;
    }
</style>
{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="logs-header">
        <div>
            <h1>Plex Server Logs</h1>
            <p style="color: var(--text-secondary); margin-top: 4px;">View Plex Media Server logs for troubleshooting</p>
        </div>
        <div class="logs-controls">
            <select id="logFile" class="log-file-selector">
                <option value="">Loading files...</option>
            </select>
            <select id="filterLevel">
                <option value="">All Levels</option>
                <option value="DEBUG">DEBUG</option>
                <option value="INFO">INFO</option>
                <option value="WARNING">WARNING</option>
                <option value="ERROR">ERROR</option>
                <option value="CRITICAL">CRITICAL</option>
            </select>
            <input type="number" id="linesCount" value="500" min="100" max="10000" step="100" style="width: 100px;">
            <button class="btn btn-outlined" id="refreshLogsButton">Refresh</button>
            <button class="btn btn-outlined" id="autoScrollBtn">Auto-scroll: ON</button>
        </div>
    </div>
    
    <div class="logs-viewer" id="logsViewer">
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            Loading Plex logs...
        </div>
    </div>
</div>

<div class="auto-scroll-indicator" id="autoScrollIndicator">
    Auto-scroll paused. Click to resume.
</div>

<script nonce="{{ request.state.csp_nonce }}">
    let autoScroll = true;
    let logEntries = [];
    let logFiles = [];
    
    // Load log files on page load
    document.addEventListener('DOMContentLoaded', async () => {
        const logFileSelect = document.getElementById('logFile');
        if (logFileSelect) {
            logFileSelect.addEventListener('change', () => loadLogs());
        }

        const filterLevelSelect = document.getElementById('filterLevel');
        if (filterLevelSelect) {
            filterLevelSelect.addEventListener('change', () => loadLogs());
        }

        const linesCountInput = document.getElementById('linesCount');
        if (linesCountInput) {
            linesCountInput.addEventListener('change', () => loadLogs());
        }

        const refreshButton = document.getElementById('refreshLogsButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => loadLogs());
        }

        const autoScrollButton = document.getElementById('autoScrollBtn');
        if (autoScrollButton) {
            autoScrollButton.addEventListener('click', toggleAutoScroll);
        }

        const autoScrollIndicator = document.getElementById('autoScrollIndicator');
        if (autoScrollIndicator) {
            autoScrollIndicator.addEventListener('click', toggleAutoScroll);
        }

        await loadLogFiles();
        await loadLogs();
    });
    
    // Auto-refresh every 5 seconds
    setInterval(() => {
        if (autoScroll) {
            loadLogs(true);
        }
    }, 5000);
    
    async function loadLogFiles() {
        try {
            const response = await fetch('/plex/logs/files');
            const data = await response.json();
            logFiles = data.files || [];
            
            const select = document.getElementById('logFile');
            select.innerHTML = '<option value="">Most Recent</option>';
            
            logFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.name;
                option.textContent = `${file.name} (${formatFileSize(file.size)})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading log files:', error);
        }
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    async function loadLogs(append = false) {
        const filterLevel = document.getElementById('filterLevel').value;
        const linesCount = parseInt(document.getElementById('linesCount').value);
        const logFile = document.getElementById('logFile').value;
        
        try {
            let url = `/plex/logs/entries?lines=${linesCount}`;
            if (filterLevel) {
                url += `&filter_level=${filterLevel}`;
            }
            if (logFile) {
                url += `&log_file=${encodeURIComponent(logFile)}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                let errorMessage = data.error;
                if (data.message) {
                    errorMessage += `<br><br><small style="color: var(--text-secondary);">${data.message}</small>`;
                }
                if (data.possible_locations) {
                    errorMessage += `<br><br><small style="color: var(--text-secondary);">Possible locations:</small><ul style="text-align: left; margin-top: 8px;">`;
                    for (const [os, path] of Object.entries(data.possible_locations)) {
                        errorMessage += `<li><code>${path}</code> (${os})</li>`;
                    }
                    errorMessage += `</ul>`;
                }
                document.getElementById('logsViewer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--error);">
                        ${errorMessage}
                    </div>
                `;
                return;
            }
            
            if (!append) {
                logEntries = [];
            }
            
            logEntries = data.entries || [];
            renderLogs();
            
            if (autoScroll) {
                scrollToBottom();
            }
        } catch (error) {
            console.error('Error loading Plex logs:', error);
            document.getElementById('logsViewer').innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--error);">
                    Error loading Plex logs: ${error.message}
                </div>
            `;
        }
    }
    
    function renderLogs() {
        const viewer = document.getElementById('logsViewer');
        const wasAtBottom = isScrolledToBottom();
        
        viewer.innerHTML = logEntries.map(entry => {
            const timestamp = entry.timestamp ? 
                (new Date(entry.timestamp).toLocaleTimeString()) : 
                '';
            const level = entry.level || 'INFO';
            const message = escapeHtml(entry.message);
            
            return `
                <div class="log-entry ${entry.is_error ? 'error' : level.toLowerCase()}" data-level="${level}">
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-level ${level}">${level}</span>
                    <span class="log-message">${message}</span>
                </div>
            `;
        }).join('');
        
        if (wasAtBottom && autoScroll) {
            scrollToBottom();
        }
    }
    
    function isScrolledToBottom() {
        const viewer = document.getElementById('logsViewer');
        return viewer.scrollHeight - viewer.scrollTop <= viewer.clientHeight + 50;
    }
    
    function scrollToBottom() {
        const viewer = document.getElementById('logsViewer');
        viewer.scrollTop = viewer.scrollHeight;
    }
    
    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        const btn = document.getElementById('autoScrollBtn');
        const indicator = document.getElementById('autoScrollIndicator');
        
        if (autoScroll) {
            btn.textContent = 'Auto-scroll: ON';
            indicator.classList.remove('active');
            scrollToBottom();
        } else {
            btn.textContent = 'Auto-scroll: OFF';
            indicator.classList.add('active');
        }
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Handle scroll to detect when user scrolls up
    document.getElementById('logsViewer').addEventListener('scroll', () => {
        if (!isScrolledToBottom() && autoScroll) {
            toggleAutoScroll();
        }
    });
</script>
{% endblock %}

