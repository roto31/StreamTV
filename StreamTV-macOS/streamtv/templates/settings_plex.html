{% extends "base.html" %}
{% block title %}Plex API Integration - StreamTV{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <div>
            <div class="page-title">Plex API Integration</div>
            <p class="page-subtitle">Configure Plex Media Server API integration for enhanced EPG and schedule management.</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-outlined" type="button" id="testPlexConnectionButton">
                <span class="material-icons">network_check</span>
                Test Connection
            </button>
            <button class="btn btn-outlined" type="button" id="refreshPlexSettingsButton">
                <span class="material-icons">refresh</span>
                Reload
            </button>
            <button class="btn btn-primary" type="button" id="savePlexSettingsButton">
                <span class="material-icons">save</span>
                Save Changes
            </button>
        </div>
    </div>
    
    <div class="card status-card" id="statusCard" style="display: none;">
        <span id="statusMessage"></span>
    </div>
    
    <div class="settings-grid">
        <div class="card settings-card">
            <div class="card-title">General</div>
            <div class="form-group">
                <label for="enabled">
                    <input type="checkbox" id="enabled" style="width: auto; margin-right: 8px;">
                    Enable Plex API Integration
                </label>
                <small>Enable Plex Media Server API integration for enhanced EPG generation, channel mapping, and schedule management.</small>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-title">Server Configuration</div>
            <div class="form-group">
                <label for="baseUrl">Plex Server URL</label>
                <input type="text" id="baseUrl" placeholder="http://localhost:32400">
                <small>Your Plex Media Server URL. Default: http://localhost:32400</small>
            </div>
            <div class="form-group">
                <label for="token">Authentication Token</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="password" id="token" placeholder="Your Plex authentication token" style="flex: 1;">
                    <button class="btn btn-outlined" type="button" id="togglePlexTokenButton" style="white-space: nowrap;">
                        <span class="material-icons" id="tokenVisibilityIcon">visibility</span>
                    </button>
                </div>
                <small>Your Plex authentication token. See instructions below to obtain it.</small>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-title">EPG Integration</div>
            <div class="form-group">
                <label for="useForEpg">
                    <input type="checkbox" id="useForEpg" style="width: auto; margin-right: 8px;">
                    Use Plex API for EPG Enhancement
                </label>
                <small>Enable Plex API integration for enhanced Electronic Program Guide (EPG) generation, channel mapping, and metadata enrichment.</small>
            </div>
        </div>
    </div>
    
    <!-- Plex API Status Card -->
    <div class="card info-card">
        <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 20px;">info</span>
            Connection Status
        </div>
        <div id="connectionStatus" style="margin-top: 12px; color: var(--text-secondary); font-size: 15px; line-height: 1.5;">
            <p>Click "Test Connection" to check Plex server connectivity.</p>
        </div>
    </div>
    
    <!-- Documentation Section -->
    <div class="card info-card" style="margin-top: 16px;">
        <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 20px;">menu_book</span>
            How to Get Your Plex Token
        </div>
        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 15px; line-height: 1.5;">
            <h3 style="color: var(--text-primary); margin-top: 16px; margin-bottom: 8px;">Method 1: Browser Developer Tools</h3>
            <ol style="padding-left: 20px; margin-top: 8px;">
                <li style="margin-bottom: 8px;">Open Plex Web App in your browser: <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">http://localhost:32400/web</code> or <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">https://app.plex.tv/desktop</code></li>
                <li style="margin-bottom: 8px;">Open Developer Tools:
                    <ul style="padding-left: 20px; margin-top: 4px;">
                        <li>macOS: <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">Cmd + Option + I</code></li>
                        <li>Windows/Linux: <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">F12</code> or <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">Ctrl + Shift + I</code></li>
                    </ul>
                </li>
                <li style="margin-bottom: 8px;">Go to the <strong>Network</strong> tab in Developer Tools</li>
                <li style="margin-bottom: 8px;">Refresh the page (<code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">Cmd+R</code> or <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">F5</code>)</li>
                <li style="margin-bottom: 8px;">Find any request to your Plex server (look for requests to <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">localhost:32400</code> or <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">plex.tv</code>)</li>
                <li style="margin-bottom: 8px;">Click on the request and check the <strong>Headers</strong> tab</li>
                <li style="margin-bottom: 8px;">Look for <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">X-Plex-Token</code> in Request Headers</li>
                <li style="margin-bottom: 8px;">Copy the token value (it's a long alphanumeric string)</li>
            </ol>
            
            <div style="background: var(--surface-light); padding: 16px; border-radius: 8px; margin: 16px 0; border: 0.5px solid var(--divider);">
                <p style="margin: 0; color: var(--text-primary); font-weight: 500; margin-bottom: 8px;">üì∏ Screenshot Guide:</p>
                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">1. Open Developer Tools ‚Üí Network tab<br>
                2. Refresh page ‚Üí Find request ‚Üí Headers tab<br>
                3. Look for X-Plex-Token header ‚Üí Copy value</p>
            </div>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Method 2: Browser Console</h3>
            <ol style="padding-left: 20px; margin-top: 8px;">
                <li style="margin-bottom: 8px;">Open Plex Web App and log in</li>
                <li style="margin-bottom: 8px;">Open Developer Tools ‚Üí <strong>Console</strong> tab</li>
                <li style="margin-bottom: 8px;">Type and press Enter: <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">window.localStorage.getItem('token')</code></li>
                <li style="margin-bottom: 8px;">Copy the returned token value</li>
            </ol>
        </div>
    </div>
    
    <!-- Available Plex APIs Section -->
    <div class="card info-card" style="margin-top: 16px;">
        <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 20px;">api</span>
            Available Plex API Integrations
        </div>
        <div style="margin-top: 12px;">
            <div style="display: grid; gap: 12px;">
                <!-- EPG APIs -->
                <div class="api-section">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 20px;">tv</span>
                        EPG (Electronic Program Guide) APIs
                    </h4>
                    <div style="background: var(--surface-light); padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: var(--text-primary);">‚úÖ Integrated:</strong>
                            <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                <li><code>/livetv/dvrs/epg/channels</code> - Get channels for a lineup</li>
                                <li><code>/livetv/dvrs/epg/lineups</code> - Get available lineups</li>
                                <li><code>/livetv/dvrs/epg/channelMap</code> - Compute best channel map</li>
                                <li><code>/livetv/dvrs/epg/countries</code> - Get all available countries</li>
                            </ul>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 0.5px solid var(--divider);">
                            <strong style="color: var(--text-primary);">üìã Available:</strong>
                            <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                <li><code>/livetv/dvrs/epg/regions</code> - Get regions for a country</li>
                                <li><code>/livetv/dvrs/epg/languages</code> - Get all languages</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- DVR APIs -->
                <div class="api-section">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 20px;">dvr</span>
                        DVR APIs
                    </h4>
                    <div style="background: var(--surface-light); padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: var(--text-primary);">‚úÖ Integrated:</strong>
                            <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                <li><code>/livetv/dvrs</code> - Get all DVRs</li>
                                <li><code>/livetv/dvrs/{dvrId}</code> - Get single DVR</li>
                            </ul>
                        </div>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 0.5px solid var(--divider);">
                            <strong style="color: var(--text-primary);">üìã Available:</strong>
                            <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                <li><code>POST /livetv/dvrs</code> - Create a DVR</li>
                                <li><code>PUT /livetv/dvrs/{dvrId}/lineup</code> - Add a DVR Lineup</li>
                                <li><code>POST /livetv/dvrs/{dvrId}/reload</code> - Reload program guide</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Device APIs -->
                <div class="api-section">
                    <h4 style="color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <span class="material-icons" style="font-size: 20px;">devices</span>
                        Device APIs
                    </h4>
                    <div style="background: var(--surface-light); padding: 12px; border-radius: 8px; margin-top: 8px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: var(--text-primary);">üìã Available:</strong>
                            <ul style="margin: 4px 0 0 20px; color: var(--text-secondary);">
                                <li><code>/livetv/devices</code> - Get all devices</li>
                                <li><code>POST /livetv/devices</code> - Add a device</li>
                                <li><code>POST /livetv/devices/discover</code> - Discover devices</li>
                                <li><code>/livetv/devices/{deviceId}</code> - Get device details</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Integration Guide -->
    <div class="card info-card" style="margin-top: 16px;">
        <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
            <span class="material-icons" style="font-size: 20px;">help_outline</span>
            Integration Guide
        </div>
        <div style="margin-top: 12px; color: var(--text-secondary); font-size: 15px; line-height: 1.5;">
            <h3 style="color: var(--text-primary); margin-top: 16px; margin-bottom: 8px;">Step 1: Enable Integration</h3>
            <p>Check the "Enable Plex API Integration" checkbox above and save your settings.</p>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Step 2: Configure Server</h3>
            <p>Enter your Plex server URL (usually <code style="background: var(--surface-light); padding: 2px 6px; border-radius: 4px;">http://localhost:32400</code> or your server's IP address).</p>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Step 3: Add Token</h3>
            <p>Follow the instructions above to obtain your Plex authentication token and paste it in the "Authentication Token" field.</p>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Step 4: Enable EPG Enhancement</h3>
            <p>Check "Use Plex API for EPG Enhancement" to enable enhanced EPG generation with channel mapping and metadata enrichment.</p>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Step 5: Test Connection</h3>
            <p>Click the "Test Connection" button to verify your Plex server is accessible and your token is valid.</p>
            
            <h3 style="color: var(--text-primary); margin-top: 24px; margin-bottom: 8px;">Step 6: Restart Server</h3>
            <p>After saving your settings, restart the StreamTV server for changes to take effect.</p>
            
            <div style="background: var(--surface-light); padding: 16px; border-radius: 8px; margin: 16px 0; border: 0.5px solid var(--divider);">
                <p style="margin: 0; color: var(--text-primary); font-weight: 500; margin-bottom: 8px;">üìö Reference:</p>
                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                    Full Plex API documentation: <a href="https://developer.plex.tv/pms/" target="_blank" style="color: var(--primary);">https://developer.plex.tv/pms/</a><br>
                    EPG API endpoints: <a href="https://developer.plex.tv/pms/#tag/EPG" target="_blank" style="color: var(--primary);">https://developer.plex.tv/pms/#tag/EPG</a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .page {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }
    
    .page-title {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: 0.36px;
    }
    
    .page-subtitle {
        color: var(--text-secondary);
        margin-top: 4px;
        font-size: 17px;
    }
    
    .page-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .status-card {
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 12px 16px;
        font-size: 15px;
    }
    
    .status-card.success {
        color: var(--success);
        border-color: rgba(52, 199, 89, 0.4);
        background: rgba(52, 199, 89, 0.15);
    }
    
    .status-card.error {
        color: var(--error);
        border-color: rgba(255, 59, 48, 0.4);
        background: rgba(255, 59, 48, 0.15);
    }
    
    .status-card.info {
        color: var(--info);
        border-color: rgba(10, 132, 255, 0.4);
        background: rgba(10, 132, 255, 0.15);
    }
    
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }
    
    .settings-card {
        background: var(--surface);
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .info-card {
        background: var(--surface);
        border-radius: 12px;
        border: 0.5px solid var(--divider);
        padding: 16px;
    }
    
    .card-title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .form-group label {
        font-size: 15px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .form-group input[type="checkbox"] {
        width: auto;
        min-height: auto;
        margin-right: 8px;
    }
    
    .form-group input[type="text"],
    .form-group input[type="password"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
        background: var(--surface-light);
        border-radius: 10px;
        border: 0.5px solid var(--divider);
        color: var(--text-primary);
        font-size: 17px;
        padding: 10px 12px;
        font-family: inherit;
        min-height: 44px;
        resize: vertical;
    }
    
    .form-group small {
        color: var(--text-secondary);
        font-size: 13px;
    }
    
    .api-section {
        background: var(--surface);
        border-radius: 8px;
        padding: 12px;
        border: 0.5px solid var(--divider);
    }
    
    code {
        font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
        font-size: 13px;
    }
    
    ol, ul {
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.state.csp_nonce }}">
    document.addEventListener('DOMContentLoaded', () => {
        const testButton = document.getElementById('testPlexConnectionButton');
        if (testButton) {
            testButton.addEventListener('click', testConnection);
        }

        const refreshButton = document.getElementById('refreshPlexSettingsButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', () => loadSettings(true));
        }

        const saveButton = document.getElementById('savePlexSettingsButton');
        if (saveButton) {
            saveButton.addEventListener('click', saveSettings);
        }

        const toggleTokenButton = document.getElementById('togglePlexTokenButton');
        if (toggleTokenButton) {
            toggleTokenButton.addEventListener('click', toggleTokenVisibility);
        }

        loadSettings();
    });
    
    let tokenVisible = false;
    
    function toggleTokenVisibility() {
        tokenVisible = !tokenVisible;
        const tokenInput = document.getElementById('token');
        const icon = document.getElementById('tokenVisibilityIcon');
        if (tokenVisible) {
            tokenInput.type = 'text';
            icon.textContent = 'visibility_off';
        } else {
            tokenInput.type = 'password';
            icon.textContent = 'visibility';
        }
    }
    
    async function loadSettings(showStatus = false) {
        try {
            const response = await fetch('/api/settings/plex');
            if (!response.ok) {
                throw new Error('Failed to load settings');
            }
            const data = await response.json();
            document.getElementById('enabled').checked = data.enabled || false;
            document.getElementById('baseUrl').value = data.base_url || '';
            document.getElementById('token').value = data.token || '';
            document.getElementById('useForEpg').checked = data.use_for_epg || false;
            if (showStatus) {
                showStatusMessage('Settings refreshed from disk.', 'success');
            }
        } catch (error) {
            console.error(error);
            showStatusMessage(error.message, 'error');
        }
    }
    
    async function saveSettings() {
        try {
            const payload = {
                enabled: document.getElementById('enabled').checked,
                base_url: document.getElementById('baseUrl').value.trim() || null,
                token: document.getElementById('token').value.trim() || null,
                use_for_epg: document.getElementById('useForEpg').checked,
            };
            
            // Validate URL format if provided
            if (payload.base_url && !payload.base_url.match(/^https?:\/\/.+/)) {
                throw new Error('Plex server URL must start with http:// or https://');
            }
            
            const response = await fetch('/api/settings/plex', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            if (!response.ok) {
                const errorPayload = await response.json();
                throw new Error(errorPayload.detail || 'Failed to save settings');
            }
            
            showStatusMessage('Plex API settings saved successfully. Please restart the server for changes to take effect.', 'success');
        } catch (error) {
            console.error(error);
            showStatusMessage(error.message, 'error');
        }
    }
    
    async function testConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.innerHTML = '<p>Testing connection...</p>';
        
        try {
            const response = await fetch('/api/settings/plex/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.innerHTML = `
                    <div style="color: var(--success);">
                        <strong>‚úÖ Connection Successful!</strong>
                        <ul style="margin-top: 8px; padding-left: 20px;">
                            <li>Server: ${data.server_info?.friendlyName || 'Unknown'}</li>
                            <li>Version: ${data.server_info?.version || 'Unknown'}</li>
                            <li>DVRs Found: ${data.dvrs_count || 0}</li>
                        </ul>
                    </div>
                `;
                showStatusMessage('Plex server connection test successful!', 'success');
            } else {
                statusDiv.innerHTML = `
                    <div style="color: var(--error);">
                        <strong>‚ùå Connection Failed</strong>
                        <p style="margin-top: 8px;">${data.error || 'Unknown error'}</p>
                    </div>
                `;
                showStatusMessage('Plex server connection test failed. Check your settings.', 'error');
            }
        } catch (error) {
            statusDiv.innerHTML = `
                <div style="color: var(--error);">
                    <strong>‚ùå Connection Error</strong>
                    <p style="margin-top: 8px;">${error.message}</p>
                </div>
            `;
            showStatusMessage('Connection test failed: ' + error.message, 'error');
        }
    }
    
    function showStatusMessage(message, status) {
        const card = document.getElementById('statusCard');
        const text = document.getElementById('statusMessage');
        card.classList.remove('success', 'error', 'info');
        card.classList.add(status);
        text.textContent = message;
        card.style.display = 'block';
        setTimeout(() => {
            card.style.display = 'none';
        }, 5000);
    }
</script>
{% endblock %}

